<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.zero_wait_back.mapper.WaitingMapper">

    <!-- 현재 착석 중인 웨이팅 목록 -->
    <select id="findArrivedWaitings" resultType="com.project.zero_wait_back.dto.internal.ArrivedWaitingDto">
        SELECT
            waiting_id waitingId,
            table_id tableId,
            seated_at seatedAt,
            party_size partySize
        FROM
            waiting_tb
        WHERE
            restaurant_id = #{restaurantId}
            AND status = 'ARRIVED'
            AND is_deleted = 0
            AND created_at >= CURDATE()
    </select>


    <!-- 현재 대기 중인 큐 -->
    <select id="findWaitingQueue" resultType="com.project.zero_wait_back.dto.internal.WaitingQueueDto">
        SELECT
            waiting_id waitingId,
            wait_number waitNumber,
            party_size partySize,
            created_at createdAt
        FROM
            waiting_tb
        WHERE
            restaurant_id = #{restaurantId}
            AND status = 'WAITING'
            AND is_deleted = 0
            AND created_at >= CURDATE()
        ORDER BY
            wait_number ASC
    </select>


    <!-- 최근 7일 평균 이용시간 (분) -->
    <select id="findAvgUsageMinutes" resultType="java.lang.Integer">
        SELECT
            ROUND(AVG(TIMESTAMPDIFF(MINUTE, seated_at, finished_at)), 0)
        FROM
            waiting_tb
        WHERE
            restaurant_id = #{restaurantId}
            AND status = 'FINISHED'
            AND seated_at IS NOT NULL
            AND finished_at IS NOT NULL
            AND finished_at > seated_at
            AND is_deleted = 0
            AND created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
            AND created_at &lt; DATE_ADD(CURDATE(), INTERVAL 1 DAY)
            AND TIMESTAMPDIFF(MINUTE, seated_at, finished_at) BETWEEN 1 AND 300
    </select>


    <!-- 오늘 마지막 대기번호 -->
    <select id="findLastWaitNumberByRestaurantId" resultType="java.lang.Integer">
        SELECT
            COALESCE(MAX(wait_number), 0)
        FROM
            waiting_tb
        WHERE
            restaurant_id = #{restaurantId}
            AND is_deleted = 0
            AND created_at >= CURDATE()
    </select>

</mapper>